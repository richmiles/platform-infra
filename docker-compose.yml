services:
  # Reverse proxy with automatic HTTPS
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - internal
    depends_on:
      - ieomd
      - umami
      - noodle
      - human-index
      - richmiles-xyz
      - bullshit-or-fit
      - spark-swarm

  # Shared Postgres database
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # IEOMD - App (FastAPI + built SPA)
  ieomd:
    image: ghcr.io/richmiles/ieomd-app:${IEOMD_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+psycopg2://${IEOMD_DB_USER:-ieomd}:${IEOMD_DB_PASSWORD:?Set IEOMD_DB_PASSWORD in .env}@postgres:5432/${IEOMD_DB_NAME:-ieomd_db}
      CORS_ORIGINS: ${IEOMD_CORS_ORIGINS:-["https://ieomd.com"]}
      # Object Storage (shared bucket with project prefix)
      # Prefer IEOMD_OBJECT_STORAGE_ENABLED; OBJECT_STORAGE_ENABLED is supported for backward compatibility.
      OBJECT_STORAGE_ENABLED: ${IEOMD_OBJECT_STORAGE_ENABLED:-${OBJECT_STORAGE_ENABLED:-false}}
      OBJECT_STORAGE_ENDPOINT: https://nyc3.digitaloceanspaces.com
      OBJECT_STORAGE_BUCKET: ${SPACES_BUCKET:-platform-storage}
      OBJECT_STORAGE_PREFIX: ${IEOMD_OBJECT_STORAGE_PREFIX:-ieomd}
      OBJECT_STORAGE_ACCESS_KEY: ${SPACES_ACCESS_KEY:-}
      OBJECT_STORAGE_SECRET_KEY: ${SPACES_SECRET_KEY:-}
      OBJECT_STORAGE_REGION: nyc3
      # Matrix Notifications (SparkSwarm ops alerts)
      MATRIX_HOMESERVER_URL: ${MATRIX_HOMESERVER_URL:-}
      MATRIX_ACCESS_TOKEN: ${MATRIX_ACCESS_TOKEN:-}
      MATRIX_ROOM_ID: ${MATRIX_ROOM_ID:-}
      # Environment identifier for alerts
      ENVIRONMENT: production
      # BTCPay Server (payment processing)
      BTCPAY_WEBHOOK_SECRET: ${BTCPAY_WEBHOOK_SECRET:-}
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy

  # Umami - Privacy-focused analytics
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${UMAMI_DB_USER:-umami}:${UMAMI_DB_PASSWORD:?Set UMAMI_DB_PASSWORD in .env}@postgres:5432/${UMAMI_DB_NAME:-umami_db}
      APP_SECRET: ${UMAMI_APP_SECRET:?Set UMAMI_APP_SECRET in .env}
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy

  # Matrix/Synapse - SparkSwarm ops chat
  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      SYNAPSE_SERVER_NAME: chat.sparkswarm.com
      SYNAPSE_REPORT_STATS: "no"
      SYNAPSE_NO_TLS: "yes"
      SYNAPSE_ENABLE_REGISTRATION: "no"
      SYNAPSE_LOG_LEVEL: WARNING
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${SYNAPSE_DB_NAME:-synapse_db}
      POSTGRES_USER: ${SYNAPSE_DB_USER:-synapse}
      POSTGRES_PASSWORD: ${SYNAPSE_DB_PASSWORD:?Set SYNAPSE_DB_PASSWORD in .env}
    volumes:
      - synapse_data:/data
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy

  # Noodle - Bar rating app
  noodle:
    image: ghcr.io/richmiles/noodle-app:${NOODLE_IMAGE_TAG:-latest}
    restart: unless-stopped
    volumes:
      - noodle_data:/app/data
    networks:
      - internal

  # Human Index - private recall utility (FastAPI + static frontend)
  human-index:
    image: ghcr.io/richmiles/human-index-app:${HUMAN_INDEX_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+psycopg://${HUMAN_INDEX_DB_USER:-human_index}:${HUMAN_INDEX_DB_PASSWORD:?Set HUMAN_INDEX_DB_PASSWORD in .env}@postgres:5432/${HUMAN_INDEX_DB_NAME:-human_index_db}
      CORS_ORIGINS: ${HUMAN_INDEX_CORS_ORIGINS:-["https://humanindex.io"]}
      ENVIRONMENT: ${HUMAN_INDEX_ENVIRONMENT:-production}
      PUBLIC_BASE_URL: ${HUMAN_INDEX_PUBLIC_BASE_URL:-https://humanindex.io}
      POSTMARK_API_TOKEN: ${HUMAN_INDEX_POSTMARK_API_TOKEN:?Set HUMAN_INDEX_POSTMARK_API_TOKEN in .env}
      MAIL_FROM: ${HUMAN_INDEX_MAIL_FROM:-Human Index <records@humanindex.io>}
      MAIL_REPLY_TO: ${HUMAN_INDEX_MAIL_REPLY_TO:-}
      SESSION_TTL_DAYS: ${HUMAN_INDEX_SESSION_TTL_DAYS:-30}
      SESSION_COOKIE_NAME: ${HUMAN_INDEX_SESSION_COOKIE_NAME:-humanindex_session}
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy

  # richmiles.xyz - Static resume site
  richmiles-xyz:
    image: ghcr.io/richmiles/richmiles-xyz-app:${RICHMILES_XYZ_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      SPARK_SWARM_API_KEY: ${SPARK_SWARM_API_KEY}
      SPARK_SWARM_API_URL: http://spark-swarm:8000/api/v1
    networks:
      - internal

  # Bullshit or Fit - public landing + lead capture
  bullshit-or-fit:
    image: ghcr.io/richmiles/bullshit-or-fit:${BULLSHIT_OR_FIT_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      SPARK_SWARM_API_URL: ${BULLSHIT_OR_FIT_SPARK_SWARM_API_URL:-http://spark-swarm:8000/api/v1}
      SPARK_SLUG: ${BULLSHIT_OR_FIT_SPARK_SLUG:-bullshit-or-fit}
      CORS_ORIGINS: ${BULLSHIT_OR_FIT_CORS_ORIGINS:-https://bullshitorfit.com,https://www.bullshitorfit.com}
    networks:
      - internal

  # Spark Swarm - Project ecosystem dashboard
  spark-swarm:
    image: ghcr.io/richmiles/spark-swarm:${SPARK_SWARM_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${SPARK_SWARM_DB_USER:-spark_swarm}:${SPARK_SWARM_DB_PASSWORD:?Set SPARK_SWARM_DB_PASSWORD in .env}@postgres:5432/${SPARK_SWARM_DB_NAME:-spark_swarm_db}
      AUTO_CREATE_TABLES: "true"
      SPARK_SWARM_MASTER_KEY: ${SPARK_SWARM_MASTER_KEY:?Set SPARK_SWARM_MASTER_KEY in .env}
      SPARK_SWARM_API_KEY: ${SPARK_SWARM_API_KEY:?Set SPARK_SWARM_API_KEY in .env}
      SPARK_SWARM_AUTH_DISABLED: ${SPARK_SWARM_AUTH_DISABLED:-false}
      UMAMI_DATABASE_URL: postgresql://${UMAMI_DB_USER:-umami}:${UMAMI_DB_PASSWORD:?Set UMAMI_DB_PASSWORD in .env}@postgres:5432/${UMAMI_DB_NAME:-umami_db}
      UPTIME_STATE_PATH: /data/uptime/state.json
      MATRIX_HOMESERVER_URL: ${MATRIX_HOMESERVER_URL:-}
      MATRIX_ACCESS_TOKEN: ${MATRIX_ACCESS_TOKEN:-}
      MATRIX_ROOM_ID: ${MATRIX_ROOM_ID:-}
      EMAIL_SYNC_ENABLED: ${EMAIL_SYNC_ENABLED:-false}
      EMAIL_SYNC_INTERVAL_SECONDS: ${EMAIL_SYNC_INTERVAL_SECONDS:-300}
      MXROUTE_HOST: ${MXROUTE_HOST:-}
      MXROUTE_PORT: ${MXROUTE_PORT:-993}
      MXROUTE_IMAP_HOST: ${MXROUTE_IMAP_HOST:-}
      MXROUTE_IMAP_PORT: ${MXROUTE_IMAP_PORT:-993}
      LEADS_SMTP_HOST: ${LEADS_SMTP_HOST:-}
      LEADS_SMTP_PORT: ${LEADS_SMTP_PORT:-587}
      LEADS_SMTP_USERNAME: ${LEADS_SMTP_USERNAME:-}
      LEADS_SMTP_PASSWORD: ${LEADS_SMTP_PASSWORD:-}
      LEADS_SMTP_USE_TLS: ${LEADS_SMTP_USE_TLS:-true}
      LEADS_MAIL_FROM: ${LEADS_MAIL_FROM:-}
      LEADS_MAIL_REPLY_TO: ${LEADS_MAIL_REPLY_TO:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      SERPER_API_KEY: ${SERPER_API_KEY:-}
      # Image arena providers
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      REPLICATE_API_TOKEN: ${REPLICATE_API_TOKEN:-}
      RECRAFT_API_KEY: ${RECRAFT_API_KEY:-}
      IDEOGRAM_API_KEY: ${IDEOGRAM_API_KEY:-}
      REVE_API_KEY: ${REVE_API_KEY:-}
      REVE_API_URL: ${REVE_API_URL:-}
      # Background loops
      FLEET_DIGEST_ENABLED: ${FLEET_DIGEST_ENABLED:-false}
      FLEET_DIGEST_HOUR_UTC: ${FLEET_DIGEST_HOUR_UTC:-13}
      GITHUB_SYNC_ENABLED: ${GITHUB_SYNC_ENABLED:-false}
      GITHUB_SYNC_INTERVAL_SECONDS: ${GITHUB_SYNC_INTERVAL_SECONDS:-3600}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      SPARK_HEALTH_REVIEWER_ENABLED: ${SPARK_HEALTH_REVIEWER_ENABLED:-false}
      SPARK_HEALTH_REVIEWER_INTERVAL_SECONDS: ${SPARK_HEALTH_REVIEWER_INTERVAL_SECONDS:-3600}
      EVALUATION_DIGEST_ENABLED: ${EVALUATION_DIGEST_ENABLED:-false}
      EVALUATION_DIGEST_EMAIL_TO: ${EVALUATION_DIGEST_EMAIL_TO:-}
      EVALUATION_DIGEST_EMAIL_FROM: ${EVALUATION_DIGEST_EMAIL_FROM:-}
      MXROUTE_SMTP_HOST: ${MXROUTE_SMTP_HOST:-}
      MXROUTE_SMTP_PORT: ${MXROUTE_SMTP_PORT:-465}
      MXROUTE_USERNAME: ${MXROUTE_USERNAME:-}
      MXROUTE_PASSWORD: ${MXROUTE_PASSWORD:-}
      MARKETING_LOOP_ENABLED: ${MARKETING_LOOP_ENABLED:-false}
      RSI_FLEET_OPS_ENABLED: ${RSI_FLEET_OPS_ENABLED:-false}
      RSI_FLEET_OPS_INTERVAL_SECONDS: ${RSI_FLEET_OPS_INTERVAL_SECONDS:-3600}
      RSI_FLEET_OPS_EXECUTE_ACTIONS: ${RSI_FLEET_OPS_EXECUTE_ACTIONS:-false}
    volumes:
      - uptime_state:/data/uptime:ro
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy

  # Fleet uptime prober (logs Spark Swarm events + Matrix alerts)
  uptime-prober:
    image: ghcr.io/richmiles/spark-swarm:${SPARK_SWARM_IMAGE_TAG:-latest}
    restart: unless-stopped
    command: ["python", "-m", "app.uptime_prober"]
    environment:
      SPARK_SWARM_API_URL: http://spark-swarm:8000/api/v1
      SPARK_SWARM_API_KEY: ${UPTIME_PROBER_API_KEY:?Set UPTIME_PROBER_API_KEY in .env}
      MATRIX_HOMESERVER_URL: ${MATRIX_HOMESERVER_URL:-}
      MATRIX_ACCESS_TOKEN: ${MATRIX_ACCESS_TOKEN:-}
      MATRIX_ROOM_ID: ${MATRIX_ROOM_ID:-}
      # Probe tuning
      UPTIME_INTERVAL_SECONDS: ${UPTIME_INTERVAL_SECONDS:-60}
      UPTIME_TIMEOUT_SECONDS: ${UPTIME_TIMEOUT_SECONDS:-5}
      UPTIME_FAILS_FOR_DOWN: ${UPTIME_FAILS_FOR_DOWN:-3}
      UPTIME_SUCCESSES_FOR_UP: ${UPTIME_SUCCESSES_FOR_UP:-2}
      UPTIME_STATE_PATH: /data/uptime/state.json
    volumes:
      - uptime_state:/data/uptime
    networks:
      - internal
    depends_on:
      spark-swarm:
        condition: service_started

  # Email monitor (IMAP polling + Matrix notifications for new mail)
  email-monitor:
    image: ghcr.io/richmiles/spark-swarm:${SPARK_SWARM_IMAGE_TAG:-latest}
    restart: unless-stopped
    command: ["python", "-m", "app.email_monitor"]
    environment:
      SPARK_SWARM_API_URL: http://spark-swarm:8000/api/v1
      SPARK_SWARM_API_KEY: ${EMAIL_MONITOR_API_KEY:?Set EMAIL_MONITOR_API_KEY in .env}
      MXROUTE_IMAP_HOST: ${MXROUTE_IMAP_HOST:-}
      MXROUTE_IMAP_PORT: ${MXROUTE_IMAP_PORT:-993}
      MATRIX_HOMESERVER_URL: ${MATRIX_HOMESERVER_URL:-}
      MATRIX_ACCESS_TOKEN: ${MATRIX_ACCESS_TOKEN:-}
      MATRIX_ROOM_ID: ${MATRIX_ROOM_ID:-}
      EMAIL_MONITOR_INTERVAL_SECONDS: ${EMAIL_MONITOR_INTERVAL_SECONDS:-300}
      EMAIL_MONITOR_STATE_PATH: /data/email-monitor/state.json
      EMAIL_PASSWORDS: ${EMAIL_PASSWORDS:-}
    volumes:
      - email_monitor_state:/data/email-monitor
    networks:
      - internal
    depends_on:
      spark-swarm:
        condition: service_started

  # Lead outreach scheduler (SLA reminders/overdue flags + Matrix notifications)
  lead-scheduler:
    image: ghcr.io/richmiles/spark-swarm:${SPARK_SWARM_IMAGE_TAG:-latest}
    restart: unless-stopped
    command: ["python", "-m", "app.lead_scheduler"]
    environment:
      DATABASE_URL: postgresql://${SPARK_SWARM_DB_USER:-spark_swarm}:${SPARK_SWARM_DB_PASSWORD:?Set SPARK_SWARM_DB_PASSWORD in .env}@postgres:5432/${SPARK_SWARM_DB_NAME:-spark_swarm_db}
      LEADS_WORKER_INTERVAL_SECONDS: ${LEADS_WORKER_INTERVAL_SECONDS:-300}
      MATRIX_HOMESERVER_URL: ${MATRIX_HOMESERVER_URL:-}
      MATRIX_ACCESS_TOKEN: ${MATRIX_ACCESS_TOKEN:-}
      MATRIX_ROOM_ID: ${MATRIX_ROOM_ID:-}
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
      spark-swarm:
        condition: service_started

networks:
  internal:
    driver: bridge

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
  synapse_data:
  noodle_data:
  uptime_state:
  email_monitor_state:
