name: Docs Drift

on:
  pull_request:
  push:
    branches: [main]

jobs:
  docs_drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Docs drift (infra)
        run: |
          python3 - <<'PY'
          from __future__ import annotations

          from pathlib import Path

          def must(cond: bool, msg: str) -> None:
            if not cond:
              raise SystemExit(msg)

          compose = Path("docker-compose.yml").read_text()
          caddy = Path("Caddyfile").read_text()
          agents = Path("AGENTS.md").read_text()
          claude_path = Path("CLAUDE.md")
          must(claude_path.exists(), "missing CLAUDE.md")
          claude = claude_path.read_text()

          must("ghcr.io/richmiles/ieomd-app" in compose, "docker-compose.yml should reference ghcr.io/richmiles/ieomd-app")
          must("reverse_proxy ieomd:8000" in caddy, "Caddyfile should route ieomd to ieomd:8000")
          must("| ieomd |" in agents and "8000" in agents, "AGENTS.md should list ieomd on port 8000")
          must("| backend |" not in agents, "AGENTS.md should not list legacy backend service")
          must("docker-compose.yml" in claude and "Caddyfile" in claude, "CLAUDE.md should reference key infra files")

          print("docs_drift ok")
          PY
